<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat</title>
<style>
  /* Farbvariablen — ändern hier, nicht überall im CSS */
  :root{
    --bg: #f7f7f8;
    --panel: #ffffff;
    --text: #0b0b0b;
    --muted: red;
   /* --muted: #6b7280;*/
    --accent: #0b84ff;
/*    --accent: lightblue;*/
    --success: #16a34a;
    --danger: #ef4444;
    --footer-h: 60px;
  }
  /* Dark mode overrides */
  .dark{
    --bg: #0b0d11;
    --panel: #0f1317;
    --text: #e6eef8;
    --muted: red;
   /* --muted: #9aa6b2;*/
    --accent: #4da3ff;
    --success: #34d399;
    --danger: #fb7185;
  }

  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  body{display:flex;flex-direction:column;min-height:100vh}

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px;
    gap:8px;
    background:transparent;
  }
  .leftHead{display:flex;flex-direction:column}
  #who{font-weight:700}
  #sub{font-size:0.85rem;color:var(--muted)}

  .controls{display:flex;gap:8px;align-items:center}
  .small{
    padding:7px 10px;border-radius:9px;border:1px solid rgba(0,0,0,0.06);
    background:var(--panel);color:var(--text);font-weight:600;font-size:0.9rem;
  }
  /* Status-Badge: grün bei online */
  #status{
    border: none;
    padding:6px 10px;border-radius:8px;
    font-weight:700;
    background:transparent;
    color:var(--muted);
  }
  #status.online{ background: rgba(34,197,94,0.12); color:var(--success); }
  #status.offline{ background: transparent; color:var(--muted); opacity:0.9; }

  main{
    flex:1; overflow:auto; display:flex;flex-direction:column; gap:8px;
    padding:12px; padding-bottom: calc(var(--footer-h) + 16px); /* Platz für fixed footer */
  }

  .msg{
    max-width:84%; padding:10px 12px; border-radius:12px; background:var(--panel);
    color:var(--text); box-shadow: 0 1px 0 rgba(0,0,0,0.03); font-size:0.97rem;
    word-break:break-word;
  }
  .me{ align-self:flex-end; background:linear-gradient(180deg,var(--accent),#0a6fe0); color:white; }
  .other{ align-self:flex-start; }

  .meta{ font-size:0.75rem; color:var(--muted); margin-top:6px; display:block; }

  footer{
    position:fixed; left:0; right:0; bottom:0; height:var(--footer-h);
    display:flex; gap:8px; align-items:center; padding:8px 10px;
    background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.03));
    backdrop-filter: blur(6px);
  }
  input[type="text"]{
    flex:1; padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.08); font-size:1rem; outline:none;
    background:var(--panel); color:var(--text);
  }
  button#send{ padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:700 }

  /* Kopfhöhe mobil optimiert */
  @media (max-width:420px){
    .msg{max-width:94%;}
    header{padding:10px}
    footer{padding:8px}
  }
</style>
</head>
<body>

<header>
  <div class="leftHead">
    <div id="who">Chatraum</div>

    <div id="sub">: <span id="statusText">--</span></div>

  </div>

  <div class="controls">
    <!-- Theme, Download, Clear, Status -->
    <button class="small" id="themeBtn" aria-label="Modus wechseln">Modus</button>

    <button class="small" id="downloadBtn" aria-label="Chat herunterladen"></button> 

    <button class="small" id="clearBtn" aria-label="Chat löschen" title="Löscht lokalen Verlauf und (optional) Firebase-Einträge"></button>
    <button id="status" class="offline" disabled aria-hidden="true">—</button>
  </div>
</header>

<main id="messages" aria-live="polite"></main>

<footer>
  <input id="inp" type="text" placeholder="Nachricht..." aria-label="Nachricht">
  <button id="send">Senden</button>
</footer>

<!-- Firebase SDK (compat, wie vorher) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
/* ================= Configuration =================
   Trage hier deine Firebase-Web-Konfig ein (wie vorher).
   Die Realtime Database (databaseURL) muss vorhanden sein.
*/
const FIREBASE_CONFIG = {
  // apiKey: "...",
  // authDomain: "...",
  // databaseURL: "https://projekt-default-rtdb.firebaseio.com",
  // projectId: "...",
  // storageBucket: "...",
  // messagingSenderId: "...",
  // appId: "..."
  
  apiKey: "AIzaSyBl9SV2KezN1QzwnOQeOopnwrdi0ti13Pc",
  authDomain: "adressc-8d600.firebaseapp.com",
  databaseURL: "https://adressc-8d600-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "adressc-8d600",
  storageBucket: "adressc-8d600.firebasestorage.app",
  messagingSenderId: "71318669432",
  appId: "1:71318669432:web:590a9111cfece6c73c058d",
  measurementId: "G-JFFCNCXCEW"

  
};
/* ================================================= */

const KEY_NAME = 'chat_name';
const KEY_HISTORY = 'chat_history';
const NAME_PROMPT = 'Wie heißt du?';

/* ---------- UI references ---------- */
const whoEl = document.getElementById('who');
const messagesEl = document.getElementById('messages');
const inp = document.getElementById('inp');
const sendBtn = document.getElementById('send');
const themeBtn = document.getElementById('themeBtn');
const downloadBtn = document.getElementById('downloadBtn');
const clearBtn = document.getElementById('clearBtn');
const statusEl = document.getElementById('status');
const statusText = document.getElementById('statusText');

/* ---------- Name ---------- */
let name = localStorage.getItem(KEY_NAME);
if (!name) {
  name = (prompt(NAME_PROMPT) || '').trim() || 'Gast';
  localStorage.setItem(KEY_NAME, name);
}
whoEl.textContent = name + '✨';

/* ---------- Theme handling (keeps contrast) ---------- */
if (localStorage.getItem('chat_dark') === '1') document.documentElement.classList.add('dark');
themeBtn.addEventListener('click', () => {
  const d = document.documentElement.classList.toggle('dark');
  localStorage.setItem('chat_dark', d ? '1' : '0');
});

/* ---------- Local history (sofort anzeigen) ---------- */
let history = [];
try { const raw = localStorage.getItem(KEY_HISTORY); if (raw) history = JSON.parse(raw); } catch(e){ history = []; }
function saveLocal(){ localStorage.setItem(KEY_HISTORY, JSON.stringify(history)); }
function render(){
  messagesEl.innerHTML = '';
  history.forEach(m => {
    const el = document.createElement('div');
    el.className = 'msg ' + (m.name === name ? 'me' : 'other');
    // Name + Text + kleine Zeit
    const t = m.time ? (' • ' + new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})) : '';
    el.innerHTML = `<strong style="display:block">${m.name}</strong><span>${escapeHtml(m.text)}</span><span class="meta">${t}</span>`;
    messagesEl.appendChild(el);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* safe simple html-escape for messages */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* ---------- Firebase init & sync ---------- */
let firebaseConnected = false;
let dbRef = null;

function setStatusOnline(on){
  if (on){
    statusEl.classList.remove('offline'); statusEl.classList.add('online');
    statusEl.textContent = 'online';
    statusText.textContent = 'online';
  } else {
    statusEl.classList.remove('online'); statusEl.classList.add('offline');
    statusEl.textContent = 'offline';
    statusText.textContent = 'offline';
  }
}

function initFirebase(){
  if (!FIREBASE_CONFIG || !FIREBASE_CONFIG.databaseURL) {
    setStatusOnline(false);
    console.warn('Firebase-Konfig fehlt oder databaseURL nicht gesetzt. Bitte FIREBASE_CONFIG eintragen.');
    return;
  }
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.database();
    dbRef = db.ref('simple_chat_room/messages');
    // listen for realtime additions
    dbRef.on('child_added', snap => {
      const m = snap.val();
      if (m) pushIfNew(m);
    });
    setStatusOnline(true);
    firebaseConnected = true;
  } catch(e) {
    console.error('Firebase init failed', e);
    setStatusOnline(false);
  }
}

/* ---------- push if new and render ---------- */
function pushIfNew(m){
  if (!m || !m.id) m.id = Date.now() + '-' + Math.random().toString(36).slice(2,8);
  if (!history.find(x => x.id === m.id)){
    history.push(m);
    if (history.length > 2000) history = history.slice(-2000);
    saveLocal();
    render();
  }
}

/* ---------- send message ---------- */
function send(){
  const text = inp.value.trim();
  if (!text) return;
  const m = { id: Date.now() + '-' + Math.random().toString(36).slice(2,8), name, text, time: Date.now() };
  pushIfNew(m);
  inp.value = '';
  // push to firebase for distribution
  if (firebaseConnected && dbRef) {
    dbRef.push(m).catch(e => console.warn('Firebase push failed', e));
  } else {
    console.warn('Nicht mit Firebase verbunden: Nachricht nur lokal gespeichert.');
  }
}

/* ---------- download chat as JSON ---------- */
 downloadBtn.addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `chat_history_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* ---------- clear chat (local + optional firebase) ---------- */
clearBtn.addEventListener('click', async () => {
  if (!confirm('Chatverlauf lokal löschen? (Firebase bleibt unberührt, wenn du nicht bestätigst)')) return;
  // lokal löschen
  history = [];
  saveLocal();
  render();
  // fragen ob auch Firebase-Einträge entfernt werden sollen (Achtung: vermeidet versehentliches Löschen)
  if (firebaseConnected && confirm('Auch alle Nachrichten in Firebase löschen? (dies wirkt global)')) {
    try {
      await dbRef.remove();
      alert('Firebase-Nachrichten gelöscht.');
    } catch (e) {
      console.warn('Firebase remove failed', e);
      alert('Löschen in Firebase fehlgeschlagen (Konsole prüfen).');
    }
  }
});

/* ---------- events ---------- */
sendBtn.addEventListener('click', send);
inp.addEventListener('keydown', e => { if (e.key === 'Enter') send(); });

/* ---------- start ---------- */
render();
initFirebase();

/* ---------- accessibility nicety: focus input on open ---------- */
inp.focus();

</script>
</body>
</html>